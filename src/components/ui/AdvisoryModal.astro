---

---

<div id="advisory-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <button id="close-modal" class="close-btn">&times;</button>

        <h2 class="glitch" data-text="AGENDAR ASESORÍA">AGENDAR ASESORÍA</h2>
        <p class="subtitle">CONECTANDO CON EL NÚCLEO</p>

        <form id="advisory-form" class="advisory-form">
            <div class="input-group">
                <label for="programmer-select">PROGRAMADOR EXPERTO</label>
                <div class="select-wrapper">
                    <select id="programmer-select" name="programmer" required>
                        <option value="" disabled selected
                            >Cargando operadores...</option
                        >
                    </select>
                    <div class="select-arrow"></div>
                </div>
            </div>

            <div class="input-group">
                <label for="schedule-select">HORARIO DISPONIBLE</label>
                <div class="select-wrapper">
                    <select
                        id="schedule-select"
                        name="schedule"
                        required
                        disabled
                    >
                        <option value="" disabled selected
                            >Primero selecciona un operador</option
                        >
                    </select>
                    <div class="select-arrow"></div>
                </div>
            </div>

            <div class="row">
                <div class="input-group">
                    <label for="user-name">USUARIO</label>
                    <input type="text" id="user-name" name="name" readonly />
                    <div class="input-line"></div>
                </div>
                <div class="input-group">
                    <label for="user-email">CORREO</label>
                    <input type="email" id="user-email" name="email" readonly />
                    <div class="input-line"></div>
                </div>
            </div>

            <div class="input-group">
                <label for="subject">ASUNTO</label>
                <textarea
                    id="subject"
                    name="subject"
                    rows="3"
                    placeholder="Describe el objetivo de la asesoría..."
                    required></textarea>
                <div class="input-line"></div>
            </div>

            <button type="submit" id="submit-advisory-btn" class="cyber-button">
                CONFIRMAR ENLACE
                <span class="btn-glitch"></span>
            </button>
        </form>

        <div id="success-message" class="success-message hidden">
            <div class="success-icon">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="feather feather-check-circle"
                    ><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"
                    ></path><polyline points="22 4 12 14.01 9 11.01"
                    ></polyline></svg
                >
            </div>
            <h3>¡ENLACE ESTABLECIDO!</h3>
            <p>
                Tu solicitud ha sido enviada al programador.<br />Recibirás una
                respuesta en tus solicitudes.
            </p>
            <button id="close-success" class="cyber-button small"
                >ENTENDIDO</button
            >
        </div>
    </div>
</div>

<style>
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(5, 10, 8, 0.9);
        backdrop-filter: blur(10px);
        z-index: 2000;
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .modal-overlay.active {
        opacity: 1;
        pointer-events: auto;
    }

    .modal-content {
        background: rgba(10, 20, 15, 0.95);
        border: 1px solid var(--neon-green);
        padding: 2.5rem;
        border-radius: 16px;
        width: 90%;
        max-width: 600px;
        position: relative;
        box-shadow: 0 0 50px rgba(57, 255, 20, 0.15);
        transform: scale(0.9);
        transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .close-btn {
        position: absolute;
        top: 1rem;
        right: 1.5rem;
        background: none;
        border: none;
        color: var(--text-dim);
        font-size: 2rem;
        cursor: pointer;
        transition: color 0.3s;
    }

    .close-btn:hover {
        color: var(--neon-green);
    }

    h2 {
        text-align: center;
        color: var(--text-main);
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .subtitle {
        text-align: center;
        color: var(--cyber-purple);
        font-size: 0.9rem;
        letter-spacing: 2px;
        margin-bottom: 2rem;
    }

    .input-group {
        margin-bottom: 1.5rem;
        position: relative;
    }

    .row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
    }

    label {
        display: block;
        color: var(--text-dim);
        font-size: 0.75rem;
        letter-spacing: 1px;
        margin-bottom: 0.5rem;
    }

    input,
    select,
    textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid var(--glass-border);
        border-radius: 4px;
        color: var(--text-main);
        font-family: var(--font-body);
        font-size: 1rem;
        padding: 0.75rem;
        outline: none;
        transition: border-color 0.3s;
    }

    input:focus,
    select:focus,
    textarea:focus {
        border-color: var(--neon-green);
    }

    input[readonly] {
        opacity: 0.7;
        cursor: not-allowed;
        border-color: transparent;
        padding-left: 0;
    }

    select:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .select-wrapper {
        position: relative;
    }

    option {
        background: #000;
        color: white;
    }

    .cyber-button {
        width: 100%;
        padding: 1rem;
        background: var(--neon-green);
        border: none;
        color: var(--deep-jungle);
        font-family: var(--font-heading);
        font-weight: bold;
        font-size: 1.1rem;
        letter-spacing: 2px;
        cursor: pointer;
        margin-top: 1rem;
        transition: all 0.3s;
    }

    .cyber-button:hover {
        box-shadow: 0 0 20px var(--neon-green);
        transform: translateY(-2px);
    }

    .cyber-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .cyber-button.small {
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        width: auto;
        min-width: 150px;
        margin: 0 auto;
        display: block;
    }

    /* Success Message Styles */
    .success-message {
        text-align: center;
        padding: 2rem;
        animation: fadeIn 0.5s ease;
    }

    .success-message.hidden {
        display: none;
    }

    .advisory-form.hidden {
        display: none;
    }

    .success-icon {
        color: var(--neon-green);
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        animation: pulse 2s infinite;
    }

    .success-message h3 {
        color: var(--neon-green);
        font-size: 1.8rem;
        margin-bottom: 1rem;
        font-family: var(--font-heading);
        letter-spacing: 2px;
    }

    .success-message p {
        color: var(--text-main);
        margin-bottom: 2rem;
        line-height: 1.6;
    }

    @keyframes pulse {
        0% {
            transform: scale(1);
            filter: drop-shadow(0 0 0px var(--neon-green));
        }
        50% {
            transform: scale(1.1);
            filter: drop-shadow(0 0 15px var(--neon-green));
        }
        100% {
            transform: scale(1);
            filter: drop-shadow(0 0 0px var(--neon-green));
        }
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @media (max-width: 600px) {
        .row {
            grid-template-columns: 1fr;
            gap: 0;
        }
    }
</style>

<script>
    const modal = document.getElementById("advisory-modal");
    const closeBtn = document.getElementById("close-modal");
    const form = document.getElementById("advisory-form");
    const successMessage = document.getElementById("success-message");
    const closeSuccessBtn = document.getElementById("close-success");
    const nameInput = document.getElementById("user-name") as HTMLInputElement;
    const emailInput = document.getElementById(
        "user-email",
    ) as HTMLInputElement;
    const programmerSelect = document.getElementById(
        "programmer-select",
    ) as HTMLSelectElement;
    const scheduleSelect = document.getElementById(
        "schedule-select",
    ) as HTMLSelectElement;
    const submitBtn = document.getElementById(
        "submit-advisory-btn",
    ) as HTMLButtonElement;

    // Store loaded schedules data
    let loadedSchedules: any[] = [];

    // Load programmers from API when modal opens
    async function loadProgrammers() {
        try {
            const { getAllProfiles } =
                await import("../../lib/services/profileService");
            const profiles = await getAllProfiles();

            programmerSelect.innerHTML =
                '<option value="" disabled selected>Seleccionar Operador</option>';
            profiles.forEach((profile: any) => {
                const option = document.createElement("option");
                option.value = profile.userId.toString();
                option.textContent =
                    profile.userName || `Programador #${profile.userId}`;
                programmerSelect.appendChild(option);
            });

            if (profiles.length === 0) {
                programmerSelect.innerHTML =
                    '<option value="" disabled selected>No hay operadores disponibles</option>';
            }
        } catch (error) {
            console.error("Error loading programmers:", error);
            programmerSelect.innerHTML =
                '<option value="" disabled selected>Error al cargar operadores</option>';
        }
    }

    // Load schedules when a programmer is selected
    async function loadSchedulesForProgrammer(programmerId: number) {
        scheduleSelect.disabled = true;
        scheduleSelect.innerHTML =
            '<option value="" disabled selected>Cargando horarios...</option>';

        try {
            const { getSchedulesByProgrammer } =
                await import("../../lib/services/scheduleService");
            const schedules = await getSchedulesByProgrammer(programmerId);
            loadedSchedules = schedules;

            scheduleSelect.innerHTML =
                '<option value="" disabled selected>Seleccionar horario</option>';

            if (schedules.length === 0) {
                scheduleSelect.innerHTML =
                    '<option value="" disabled selected>No hay horarios disponibles</option>';
                return;
            }

            schedules.forEach((s: any, index: number) => {
                const option = document.createElement("option");
                option.value = index.toString();
                const dateFormatted = s.date;
                const timeFormatted = s.time;
                const modalityLabel =
                    s.modality === "VIRTUAL" ? "Virtual" : "Presencial";
                const isBooked = s.status !== "AVAILABLE"; // Check status

                option.textContent = `${dateFormatted} - ${timeFormatted} (${modalityLabel}) ${isBooked ? "(OCUPADO)" : ""}`;

                if (isBooked) {
                    option.disabled = true;
                    option.style.color = "#ff4444"; // Visual cue
                }

                scheduleSelect.appendChild(option);
            });

            scheduleSelect.disabled = false;
        } catch (error) {
            console.error("Error loading schedules:", error);
            scheduleSelect.innerHTML =
                '<option value="" disabled selected>Error al cargar horarios</option>';
        }
    }

    // Programmer select change handler
    if (programmerSelect) {
        programmerSelect.addEventListener("change", () => {
            const programmerId = parseInt(programmerSelect.value);
            if (programmerId) {
                loadSchedulesForProgrammer(programmerId);
            }
        });
    }

    // Function to open modal (can be called globally)
    (window as any).openAdvisoryModal = () => {
        if (modal) {
            modal.classList.add("active");
            // Reset state
            if (form) form.classList.remove("hidden");
            if (successMessage) successMessage.classList.add("hidden");

            // Pre-fill user data from localStorage
            const userStr = localStorage.getItem("ciber_user");
            if (userStr) {
                const user = JSON.parse(userStr);
                if (nameInput) nameInput.value = user.name || "";
                if (emailInput) emailInput.value = user.email || "";
            }

            // Reset schedule select
            scheduleSelect.disabled = true;
            scheduleSelect.innerHTML =
                '<option value="" disabled selected>Primero selecciona un operador</option>';
            loadedSchedules = [];

            // Load programmers
            loadProgrammers();
        }
    };

    const closeModalInfo = () => {
        if (modal) modal.classList.remove("active");
    };

    if (closeBtn) closeBtn.addEventListener("click", closeModalInfo);
    if (closeSuccessBtn)
        closeSuccessBtn.addEventListener("click", closeModalInfo);

    if (form) {
        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            const userStr = localStorage.getItem("ciber_user");
            if (!userStr) {
                alert("Debes iniciar sesion para agendar una asesoria.");
                return;
            }
            const user = JSON.parse(userStr);

            const programmerId = parseInt(programmerSelect.value);
            const scheduleIndex = parseInt(scheduleSelect.value);
            const selectedSchedule = loadedSchedules[scheduleIndex];

            if (!selectedSchedule) {
                alert("Selecciona un horario valido.");
                return;
            }

            const subjectEl = document.getElementById(
                "subject",
            ) as HTMLTextAreaElement;
            const message = subjectEl?.value || "";

            // Disable button during request
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = "ENVIANDO...";
            }

            if (!programmerId) {
                alert(
                    "Error: No se ha detectado el ID del programador seleccionado.",
                );
                return;
            }

            try {
                const { createAdvisory } =
                    await import("../../lib/services/advisoryService");

                console.log("Creating advisory with payload:", {
                    programmerId,
                    userId: parseInt(user.id),
                    message: message,
                    date: selectedSchedule.date,
                    time: selectedSchedule.time,
                    modality: selectedSchedule.modality,
                    scheduleId: selectedSchedule.id,
                });

                await createAdvisory({
                    programmerId: programmerId,
                    userId: parseInt(user.id),
                    message: message,
                    date: selectedSchedule.date,
                    time: selectedSchedule.time,
                    modality: selectedSchedule.modality,
                    scheduleId: selectedSchedule.id, // Ensure this is passed!
                });

                // Show success
                form.classList.add("hidden");
                if (successMessage) successMessage.classList.remove("hidden");
            } catch (error: any) {
                console.error("Error creating advisory:", error);
                alert("Error al crear la asesoria: " + error.message);
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = "CONFIRMAR ENLACE";
                }
            }
        });
    }

    // Close on click outside
    if (modal) {
        modal.addEventListener("click", (e) => {
            if (e.target === modal) {
                modal.classList.remove("active");
            }
        });
    }
</script>
